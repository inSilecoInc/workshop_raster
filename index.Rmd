---
title: "Raster with R"
author: "inSileco Team"
date: "2020/12/15"
output:
  xaringan::moon_reader:
    css: [default, rd.css, rd-font.css, "hygge"]
    lib_dir: assets
    seal: false
    nature:
      highlightStyle: dracula
      countIncrementalSlides: false
      beforeInit: "macros.js"
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  dev = "png",
  dpi = 108,
  fig.width = 5,
  fig.height = 4,
  fig.align = 'center',
  width = 120
)
mypar <- list(fg = "#37abc8", bg = "transparent", las = 1)
par(mypar)
# library(icon)
rfa <- function(...) icon::fontawesome(...)
library(raster)
rar <- raster("data/bathy.tif")  
class(rar)
library(stars)
ras <- read_stars("data/bathy.tif")  
class(ras)
stl <- sf::st_read("data/st_laurence.geojson")  
```


class: title-slide, middle


## .font200[`r icon::fontawesome("r-project")`asters]

<br><br>

.instructors[
  .font180[Manipulate rasters with `r rfa("r-project")`]
  <br><br><br>
  .authors140[David Beauchesne & Kevin Cazelles]
  <br><br>
  `r format(Sys.time(), '%B %d, %Y')`
]

<br><br><br><br>

<img src="img/logoW.png" width="150px"></img>

.instructors[Content under [`r rfa("creative-commons")` `r rfa("creative-commons-by")`](https://creativecommons.org/licenses/by/4.0/)  unless othewise specified]




---

class: inverse, center, middle

# Learning objectives

![:custom_hr]()

## .font160[`r rfa("map")`  + `r rfa("r-project")`]


---

# Learning objectives

<br>

### Learn how to visualize raster interactively with `r rfa("r-project")`

--

1. Understand the benefits of manipulating raster files with `r rfa("r-project")`

--

2. Learn how to read and write raster files with `r rfa("r-project")`

--

3. Learn how to manipulate rasters `r rfa("r-project")`

--

4. Learn how to visualize rasters with `r rfa("r-project")`


---

class: inverse, center, middle

# `r rfa("info-circle")` Rationalize

![:custom_hr]()

## Why use `r rfa("r-project")` for rasters? (~15min)


???

If after the workshop if what follows makes sense and you feel it is kid of true, it would a success. 




---

# Raster files 

> Raster files are grids of equally sized (most often) cells (or pixels).

--

> Every cell has a value (or a missing values).

--

> Cells are georeferenced: coordinates + CRS 

--

> Commonly used to represent continuous phenomena (e.g. temperature, elevation) and images (airborne or satellite imagery).




---
# Raster files 

- Examples of raster file formats: 

  - **GeoTIFF** (see https://trac.osgeo.org/geotiff)
  - **NetCDF** (see https://www.unidata.ucar.edu/software/netcdf/)
  - **KML** (also supports vector objects, see https://www.ogc.org/standards/kml/)
  - **GeoPackage** (also supports vector objects, see https://www.ogc.org/standards/geopackage)
  
--

- `r icon::fontawesome("info-circle")` More details :

  - https://gisgeography.com/gis-formats/
  - https://gdal.org/drivers/raster/index.html


---
# About `r rfa("r-project")`

> R is a programming language and free software environment for statistical computing and graphics supported by the R Foundation for Statistical Computing. &nbsp;&nbsp; [Wikipedia](https://bit.ly/2WFv1Nu)

--

.center[![:scale 50%](https://roelverbelen.netlify.app/img/hex-stickers.png)]



---
# Coding vs clicking

### 1. Programming/coding allows to automate what is frequently done!

--

### 2. Allow to make an analysis/a report reproducible 

--

  - create data pipeline 
  - for colleagues and future you

--

### 3. Increase efficiency (spend more time thinking)


--

### 4. Feeling empowered



???

One is not better than the other
do more, oik but do it in a better way


---
# Why `r rfa("r-project")`?

<br>

### 1. Freeware + Open source

--

### 2. **Package ecosystem** is rich and under active development  

--

### 3. Many packages connect `r rfa("r-project")` to other software/language

--

### 4. Community is wide, quite involved, responsive

--

### 5. You are most likely already using it! You are not starting from scratch

--

### **`r rfa("arrow-right")` Very little cannot be done with `r rfa("r-project")`**


???

Very few people look at the R source code but many people are now involved in package dev via GH or GL.

R Python Julia, whatever, language itself matters less that these
If you have time to learn a bit it might sometime makes sense, notably to work with other colleagues.

You don't start at 0
















---

class: inverse, center, middle

# `r rfa("pen")` Input/Ouput 

![:custom_hr]()

## Read and write raster files (30min)

???

Will introduce a bit more package to deal with raster in R


---
# `r rfa("r-project")` packages ecosystem for spatial objects

--

## Classes and Methods 

--

## Statistical Analyses

--

## Visualisation

--

## Data Retrieval 

---
# `r rfa("r-project")` packages ecosystem for spatial objects

## Classes and Methods 

--

### Vectors 

- [`sp`](https://CRAN.R-project.org/package=sp)
- [`sf`](https://CRAN.R-project.org/package=sf) `r rfa("check")`

--

### **Rasters** (our main focus)

- [`raster`](https://CRAN.R-project.org/package=raster) `r rfa("check")`
- [`stars`](https://CRAN.R-project.org/package=stars) `r rfa("check")`
- [`terra`](https://CRAN.R-project.org/package=terra) 

`r icon::fontawesome("info-circle")` https://keen-swartz-3146c4.netlify.app/raster.html#package-stars
`r icon::fontawesome("info-circle")` https://github.com/rspatial (15 packages)

???

Not visualisation later 



---
# Raster packages

### [`raster`](https://CRAN.R-project.org/package=raster) .font90[03/2010 (1.0.0) &nbsp; // &nbsp; 11/2020 (3.3-7)]
  
<br>

--
  
### [`terra`](https://CRAN.R-project.org/package=terra) .font90[03/2019 (0.5-2) &nbsp; // &nbsp; 11/2020 (0.9-11)]
  
> terra is an R package that replaces raster. It has a very similar interface, but it is simpler and much faster. 

<br>
--
  
### [`stars`](https://CRAN.R-project.org/package=stars) .font90[07/2018  (0.1-1) &nbsp; // &nbsp; 07/2020 (0.4-3)]
  
> Reading, manipulating, writing and plotting spatiotemporal arrays (raster and vector data cubes) in 'R'. 

Depends on [`sf`](https://CRAN.R-project.org/package=sf).
Note that `stars` and `sf` are [Tidyverse](https://www.tidyverse.org/) friendly.



---
# Package [`raster`](https://CRAN.R-project.org/package=raster)


### - Well documented 
  
  - see https://rspatial.org/raster/
  - many blog posts and tutorials (e.g. https://datacarpentry.org/r-raster-vector-geospatial/01-raster-structure/)

<!-- length(devtools::revdep("raster", dependencies = c("Depends", "
   Imports"))) -->

--

### - 383 packages depend on or import `raster` 

--

### - Depends on `sp` but also works with `sf`.


---
# Package [`stars`](https://CRAN.R-project.org/package=stars): SpatioTemporal ARrayS

### Extent `sf` to Raster and Vector Datacubes

.center[[![:scale 62%](https://raw.githubusercontent.com/r-spatial/stars/master/images/cube3.png)](https://r-spatial.github.io/stars/index.html)] 
.right[.font80[see https://r-spatial.github.io/stars/index.html]]


---
# Package [`stars`](https://CRAN.R-project.org/package=stars): SpatioTemporal ARrayS

### - Well documented too

.center[![:scale 92%](img/pkgdown_stars.png)]
.right[.font80[see https://r-spatial.github.io/stars/index.html]]

--

### - 9 packages depend on [`stars`](https://CRAN.R-project.org/package=stars)

### - So far, less material available online.


---
# Read a raster file 


## .center[.font200[ `r rfa("file")` `r rfa("arrow-right")` `r rfa("r-project")`]]

<br>

--

### 1. Files you created 

--

### 2. Files you found on the Internet 

--

### 3. `r rfa("r-project")` packages to download raster files



---
# Example file 

![Accessed 16/12/2020](img/gebco.png)

- https://download.gebco.net/ 
- `r icon::fontawesome("link")` [link to the file](2Badded)



---
# Read with [`raster`](https://CRAN.R-project.org/package=raster)


```{R read_raster}
library(raster)
rar <- raster("data/bathy.tif")  
class(rar)
```


---
# Read with [`raster`](https://CRAN.R-project.org/package=raster)

```{R plot_raster}
plot(rar)
```



---
# Read with [`stars`](https://CRAN.R-project.org/package=stars)

```{R read_stars}
library(stars)
ras <- read_stars("data/bathy.tif")   # argument `driver` to specify the driver
class(ras)
```

---
# Read with [`stars`](https://CRAN.R-project.org/package=stars)

```{R plot_stars}
plot(ras)
```

---

# So ...

<br>

## - GeoTIFF `r icon::fontawesome("check")`

--

## - Other formats, how do we know?



---
# Check read/write capabilities with [`raster`](https://CRAN.R-project.org/package=raster)


`r icon::fontawesome("exclamation-circle")`  [`rgdal`](https://CRAN.R-project.org/package=rgdal) is required

```{R raster_drivers}
ra_dr <- rgdal::gdalDrivers()
head(ra_dr)
```

--

```{R raster_drivers2}
ra_dr[which(ra_dr$name == "GTiff"), ]
```

---
# Check read/write capabilities with [`stars`](https://CRAN.R-project.org/package=stars)

`r icon::fontawesome("exclamation-circle")` [`sf`](https://CRAN.R-project.org/package=rgdal) is required



```{R stars_drivers}
st_dr <- sf::st_drivers(what = "raster")
head(st_dr)
```

<!-- (-73/-41 62/37) see `data` -->

---
# Check read/write capabilities with [`stars`](https://CRAN.R-project.org/package=stars)


```{R stars_drivers2}
st_dr[which(st_dr$name == "GTiff"), ]
```

--
.right[

.font80[`r icon::fontawesome("info-circle")` https://gdal.org/drivers/raster/index.html]

.font80[`r icon::fontawesome("info-circle")` https://keen-swartz-3146c4.netlify.app/intro.html#reading]

]




---
# Write raster files

##  .center[.font200[`r rfa("r-project")` `r rfa("arrow-right")` `r rfa("file")`]]

--

## - Share the output file

--

## - Use another software (e.g. QGIS)

--

<br>

### `r icon::fontawesome("exclamation-circle")` Create an `output` directory

```{R create_dir}
dir.create("output", showWarnings = FALSE)
```


---
# Write with [`raster`](https://CRAN.R-project.org/package=raster)

```{R write_raster0}
ra_dr$name[ra_dr$create]
```

---
# Write with [`raster`](https://CRAN.R-project.org/package=raster)

```{R write_raster1, eval = FALSE}
writeRaster(rar, filename = "output/rar.gpkg", format = "GPKG", overwrite = TRUE)
```


---
# Write with [`stars`](https://CRAN.R-project.org/package=stars)

```{R write_stars0}
sort(st_dr$name[st_dr$write])
```

---
# Write with [`stars`](https://CRAN.R-project.org/package=stars)

```{R write_stars1, eval = FALSE}
write_stars(ras, dsn = "output/ras.gpkg", driver = "GPKG")
```

`r rfa("pencil-alt")` dsn stands for **data source name**.


---
# `r icon::fontawesome("flag-checkered")` Recap 

<br><br>

| Action            | *raster*                 | *stars*               |
|:------------------|:-------------------------|:----------------------|
| list drivers      | `rgdal::gdalDrivers()`   | `sf::st_drivers()`    |
| read files        | `raster()`               | `read_stars()`        |
| write files       | `rasterWrite()`          | `read_stars()`        |



---
# `r rfa("terminal")` R as a raster file converter 

```{r, echo = FALSE}
countdown::countdown(minutes = 10, seconds = 0)
```
<br>

--

### `r rfa("star")` Convert `bathy.tif` into `bathy.grd`.

--

### `r rfa("star")` `r rfa("star")` Create a function `conv_raster()` that handles any conversion supported.

--

### `r rfa("star")` `r rfa("star")` `r rfa("star")` Create a function that convert a object of class `RasterLayer` object to a `stars` one (and conversely)


<br>














---

class: inverse, center, middle

# `r rfa("cogs")` Manipulate 

![:custom_hr]()

## Do whatever you need with raster files (~1h15)


---
# Common operations

##  .center[.font200[`r rfa("file")` `r rfa("arrow-right")` `r rfa("r-project")` `r rfa("arrow-right")` `r rfa("file")`]]


---
# Common operations

##  .center[.font200[`r rfa("file")` `r rfa("arrow-right")` `r rfa("r-project")` `r rfa("arrow-right")` `r rfa("cogs")` `r rfa("arrow-right")` `r rfa("file")`]]

--

- change projection 
- basic calculations (e.g. average per regions, min/max)
- crop/mask 
- extraction
- resample 
- etc.

---
# What do we have? [`raster`](https://CRAN.R-project.org/package=raster)

```{R raster_obj}
class(rar)
rar
```

---
# What do we have? [`raster`](https://CRAN.R-project.org/package=raster)

```{R raster_obj_val}
values(rar)
```


---
# What do we have? [`raster`](https://CRAN.R-project.org/package=raster)

```{R raster_obj_fun}
dim(rar)
ncell(rar)
projection(rar)
bbox(rar)
extent(rar)
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj}
class(ras)
ras
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_val}
class(ras[[1]])
ras[[1]]
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun1}
dim(ras)
ncell(ras)
st_bbox(ras)
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun2}
ras_crs <- st_crs(ras)
class(ras_crs)
ras_crs
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun3}
ras_crs$input
ras_crs$proj4string
ras_crs$epsg
```
--

- https://epsg.io/
- https://epsg.io/4326


---
# Conversion between [`stars`](https://CRAN.R-project.org/package=stars) and [`raster`](https://CRAN.R-project.org/package=raster)


### Use a temporary file (see above)

--

```{R convert}
rar_c <- st_as_stars(rar) 
class(rar_c)
ras_c <- as(ras, "Raster") 
class(ras_c)
```

 

---
# Basic computations with [`raster`](https://CRAN.R-project.org/package=raster)

```{R bc_rar1}
class(rar[,])
rar[1, 1]
rar[1:10, 11:20]
mean(rar[,]) # or mean(as.matrix(rar))
quantile(rar[,])
```

---
# Basic computations with [`raster`](https://CRAN.R-project.org/package=raster)

```{R bc_rar1_2}
rar2 <- rar # create a copy 
rar2[rar > 0] <- NA  # filter
plot(rar2)
```


---
# Basic cell-based computations with [`stars`](https://CRAN.R-project.org/package=stars)

```{R bc_ras1}
# extract value
class(ras[[1]])
ras[[1]][1, 1]
ras[[1]][1:10, 11:20]
```

---
# Basic cell-based computations with [`stars`](https://CRAN.R-project.org/package=stars)

```{R bc_ras1_2}
mean(ras[[1]]) 
quantile(ras[[1]])
```

---
# Basic cell-based computations with [`stars`](https://CRAN.R-project.org/package=stars)
  
```{R bc_rar1_3}
ras2 <- ras # create a copy
ras2[[1]][ras[[1]] < units::as_units(0, "m")] <- NA # filter
plot(ras2)
```


---
# `r rfa("terminal")` Mean along latitude and longitude 

```{r, echo = FALSE}
countdown::countdown(minutes = 15, seconds = 0)
```

### `r rfa("star")` Compute the mean elevation/depth along the latitude or/and longitude (optional: use elevation/depth filter) 


--

### `r rfa("star")` `r rfa("star")` Create a function `mean_long_lat()` that computes mean elevation/depth along longitude and latitude (`r rfa("star")` `r rfa("star")` `r rfa("star")` include an argument to set an elevation/depth filter).

<br>





---
# Change map projection

- Reminder 

  - [`r icon::fontawesome("wikipedia-w")` List of map projections](https://en.wikipedia.org/wiki/List_of_map_projections)

--

  - [Interactive examples](https://mathigon.org/course/circles/spheres-cones-cylinders#sphere-maps)

--

- Let's use the spherical Mercator 
  - https://epsg.io/
  - https://epsg.io/3857


---
# Change map projection with [`raster`](https://CRAN.R-project.org/package=raster)

- `raster` uses [Proj](https://proj.org/) strings 
- https://epsg.io/3857

--

```{R rar_new_crs}
rar_crs <- CRS("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs")
```


---
# Change map projection with [`raster`](https://CRAN.R-project.org/package=raster)

```{R projrar, cache = TRUE}
rar_t <- projectRaster(rar, crs = rar_crs)
projection(rar_t)
plot(rar)
```


---
# Change map projection with [`stars`](https://CRAN.R-project.org/package=stars)

```{R projrar2, cache = TRUE}
ras_t <- st_transform(ras, crs = 3857)
st_crs(ras_t)
```





---
# Crop 

```{R crop0}
plot(rar)
rect(-65, 45, -60, 50)
```

---
# Crop with [`raster`](https://CRAN.R-project.org/package=raster)

```{R crop_rar, cache = TRUE}
rar_c <- crop(rar, extent(-65, -60, 45, 50))
plot(rar_c)
```

---
# Crop with [`stars`](https://CRAN.R-project.org/package=raster)

```{R crop_ras, cache = TRUE}
ext <- st_bbox(c(xmin = -65, xmax = -60, ymin = 45, ymax = 50), crs = 4326)
ras_c <- st_crop(ras, ext)
plot(ras_c)
```



---
# Mask 

Let's use a shapefile of the Gulf of the St-Lawrence 

`r icon::fontawesome("link")` https://www.marineregions.org/gazetteer.php?p=details&id=4290

```{R stl} 
(stl <- sf::st_read("data/st_laurence.geojson"))
```

---
# Mask 

Values outside of a given geometry set to `NA`

```{R plot_stl, eval = FALSE} 
plot(sf::st_geometry(stl))
```


---
# Mask with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_m, cache = TRUE} 
rar_m <- mask(rar, stl)
plot(rar_m)
```

---
# Mask with [`raster`](https://CRAN.R-project.org/package=raster)


```{R rar_m2, cache = TRUE}
rar_mi <- mask(rar, stl, inverse = TRUE)
plot(rar_mi)
```

---
# Mask with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_m, cache = TRUE} 
ras_m <- ras[stl]
plot(ras_m)
```

---
# Mask with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_m1, cache = TRUE} 
stl_i <- sf::st_difference(sf::st_as_sfc(st_bbox(ras)), stl)
plot(stl_i, col = 2)
```


---
# Mask with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_m2, cache = TRUE} 
ras_mi <- ras[stl_i]
plot(ras_mi)
```



---
# Exercice 

- `r icon::fontawesome("star")` Compute the mean depth of the St-Lawrence (Gulf and river)

- `r icon::fontawesome("star")` `r icon::fontawesome("star")` Compare the depth of the Gulf of the St-Lawrence and the depth of the St-Lawrence river (various solutions!)


```{r, echo = FALSE}
countdown::countdown(minutes = 10, seconds = 0)
```


<!-- PAUSE?? -->


---
# Warping/Resampling

### Work with rasters of different resolution 

---
# Warping/Resampling with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_warp, cache = TRUE}
# create a raser with the given resolution
mr <- matrix(runif(21*21), 21, 21)
rar_template1 <- raster(mr, xmn = -71, xmx = -55, ymn = 43, ymx = 55, 
    crs = projection(rar)) # create template
plot(rar_template1)
```

---
# Warping/Resampling with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_warp2, cache = TRUE}
rar_w1 <- resample(rar, rar_template1)
plot(rar_w1)
```

---
# Warping/Resampling with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_warp3, cache = TRUE}
rar_template2 <- raster(xmn = -71, xmx = -55, ymn = 43, ymx = 55, 
  crs = projection(rar), resolution = .25) # create template
plot(resample(rar, rar_template1))
```


---
# Warping/Resampling with [`raster`](https://CRAN.R-project.org/package=raster)

```{R ras_warp, cache = TRUE}
ras_template1 <- st_as_stars(st_bbox(ras), nx = 21, ny = 21, 
  values = runif(21 * 21)) # create template
ras_w1 <- st_warp(ras, ras_template1)
plot(ras_w1)
```

<!-- show how to do this with a second object -->

---
# Warping/Resampling with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_warp2, cache = TRUE}
ras_w2 <- st_warp(ras, cellsize = 0.25, crs = st_crs(ras)) 
plot(st_warp(ras, ras_w2))
```




---
# Rasterize 

## Vectors `r icon::fontawesome("arrow-right")` Raster 

--

## Create a raster template 



---
# Rasterize with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rasterr1, cache = TRUE, eval = FALSE}
stl_r <- rasterize(stl, dy = .1, dx = .1)
plot(stl_r)
```



---
# Rasterize with [`stars`](https://CRAN.R-project.org/package=stars)

```{R rasters1, cache = TRUE}
stl_s <- st_rasterize(stl, dy = .1, dx = .1)
plot(stl_s)
```


<!-- https://r-spatial.github.io/stars/articles/stars5.html -->



---
# Stack 

### - Collection of rasters 

### - Same extent/resolution

### - Multi-band rasters (satellite images)

### - Handle several rasters at once 


---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)


### 2 classes : `RasterBrick` and `RasterStack`

--

> The main difference is that a RasterStack is loose collection of RasterLayer objects that can refer to different files (but must all have the same extent and resolution), whereas a RasterBrick can only point to a single file. 

.right[.font80[ `r icon::fontawesome("info-circle")` https://rspatial.org/raster/spatial/4-rasterdata.html#rasterstack-and-rasterbrick]]

--

### We'll focus on `RasterStack`


---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_stc, cache = TRUE}
rar_stc <- stack(list(bath_v1 = rar, bath_v2 = rar * 2)) # could be a file path
class(rar_stc) 
nlayers(rar_stc)
```

--

```{R rar_stc1b, cache = TRUE}
class(rar_stc[[1]]) 
class(rar_stc[[2]]) 
```

---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_stc2, cache = TRUE}
plot(rar_stc)
```

---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_stc3, cache = TRUE}
plot(crop(rar_stc, extent(-65, -60, 45, 50)))
```


---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)

```{R rar_stc4, cache = TRUE}
rar_sum <- calc(rar_stc, fun = sum)
rar_sum
```

---
# Stack with [`raster`](https://CRAN.R-project.org/package=raster)


```{R rar_stc5, cache = TRUE}
plot(rar_sum) 
```


---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc0}
ras
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc1}
ras_stc1 <- c(ras, ras * 2)
names(ras_stc1) <- c("bath_v1", "bath_v2")
ras_stc1
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc1b}
plot(ras_stc1)
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)


```{R ras_stc2}
ras_stc1[1] # or ras_stc1["bath_v1"]
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)


```{R ras_stc2b}
ras_stc1[2] # or ras_stc1["bath_v2"]
```


---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc2c}
library(dplyr)
ras_stc1 %>% select("bath_v1")
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc2d}
ras_stc1 %>% mutate(bath_v3 = bath_v2 * 2)
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc3, cache = TRUE}
ras_stc2 <- c(ras, ras*2, along = "z")
ras_stc2
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc4, cache = TRUE}
plot(ras_stc2)
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc5, cache = TRUE}
ext <- st_bbox(c(xmin = -65, xmax = -60, ymin = 45, ymax = 50), crs = 4326)
plot(st_crop(ras_stc2, ext))
```


---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc6, cache = TRUE}
(ras_ap <- st_apply(ras_stc2, c(1, 2), sum))
```

---
# Stack with [`stars`](https://CRAN.R-project.org/package=stars)

```{R ras_stc6b, cache = TRUE}
plot(ras_ap)
```


---
# `r icon::fontawesome("flag-checkered")` Recap 


| Action                    | `raster`               | `stars`                |
|:--------------------------|:-----------------------|:-----------------------|
| Get projection            | `projection()`         | `st_crs()`             |
| Get bounding box          | `bbox()`               | `st_bbox()`            |
| Change projection         | `projectRaster()`      | `st_transform()`       |
| Crop                      | `crop()`               | `st_crop()`            |
| Mask                      | `mask()`               | `[]<-`                 |
| Resample                  | `projectRaster()`      | `st_warp()`            |
| Rasterize                 | `rasterize()`          | `st_rasterize()`       |
| Stack                     | `stack()` or `brick()` | `c(along=...)`         |
| Apply functions on stacks | `calc()`               | `st_apply()`           |


`r icon::fontawesome("info-circle")` https://r-spatial.github.io/stars/articles/stars6.html


<!-- exo? -->







---

class: inverse, center, middle

# `r rfa("map")` Visualize

![:custom_hr]()

## Static visualization (~45min)



---
# `r rfa("r-project")` packages for raster visualization

--

### Static

- [`tmap`](https://CRAN.R-project.org/package=tmap) `r icon::fontawesome("check")`
- [`ggplot2`](https://CRAN.R-project.org/package=ggplot2) 
    - `r icon::fontawesome("info-circle")` https://r-spatial.github.io/stars/reference/geom_stars.html
    - `r icon::fontawesome("info-circle")` https://ggplot2.tidyverse.org/reference/geom_tile.html
- [`ggmap`](https://CRAN.R-project.org/package=ggmap)
    - `r icon::fontawesome("info-circle")` https://github.com/dkahle/ggmap
- [`rasterVis`](https://CRAN.R-project.org/package=rasterVis)
    - `r icon::fontawesome("info-circle")` https://oscarperpinan.github.io/rastervis/

--

### Interactive 

- [`tmap`](https://CRAN.R-project.org/package=tmap) 
- [`leaflet`](https://CRAN.R-project.org/package=leaflet)
- [`mapview`](https://CRAN.R-project.org/package=mapview)

`r icon::fontawesome("info-circle")` day 2 of the workshop.


---
# base plot 




---
# tmap



---
# Exercice + countdown

1. Do that 
2. Do that 
3. Do that 
4. Do that 
5. Do that 

```{r, echo = FALSE}
countdown::countdown(minutes = 5, seconds = 0)
```


---

# Resources `r rfa("link")`

- [Geocomputation with R](https://geocompr.robinlovelace.net/)
- [Spatial Data Science](https://keen-swartz-3146c4.netlify.app/)
- [Blog R-spatial](https://www.r-spatial.org/)
- [Open Geospatial Consortium](https://www.ogc.org/)
- https://nowosad.github.io/BioGIS_19/workshop/#64