---
title: "Raster with R"
author: "inSileco Team"
date: "2020/12/15"
output:
  xaringan::moon_reader:
    css: [default, rd.css, rd-font.css, "hygge"]
    lib_dir: assets
    seal: false
    nature:
      highlightStyle: dracula
      countIncrementalSlides: false
      beforeInit: "macros.js"
---


class: title-slide, middle


## .font200[`r icon::fontawesome("r-project")`asters]

<br><br>

.instructors[
  .font180[Manipulate raster files with `r icon::fontawesome("r-project")`]
  <br><br><br>
  .authors140[David Beauchesnes & Kevin Cazelles]
  <br><br>
  `r format(Sys.time(), '%B %d, %Y')`
]

<br><br><br><br><br><br>


<img src="img/logoW.png" width="150px"></img>



```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5.25,
  fig.align = 'center',
  width = 120
)
mypar <- list(fg = "#37abc8", bg = "transparent", las = 1)
# library(icon)
rfa <- function(...) icon::fontawesome(...)
```

---

class: inverse, center, middle

# Learning objectives

![:custom_hr]()

## .font160[`r rfa("map")`  + `r rfa("r-project")`]


---

# Learning objectives

<br>

1. Understand the benefits of manipulating raster files with `r rfa("r-project")`

--

2. Learn how to read and write raster files with `r rfa("r-project")`

--

3. Learn how to manipulate rasters `r rfa("r-project")`

--

4. Learn how to visualize rasters with `r rfa("r-project")`


---

class: inverse, center, middle

# `r rfa("info-circle")` Rationalize

![:custom_hr]()

## Why use `r rfa("r-project")` for rasters? (~15min)


???

If after the workshop if what follows makes sense and you feel it is kid of true, it would a success. 




---

# Raster files 

> Raster files are grids of equally sized cells (or pixels) that all have a value (or a missing value) 

--

> Cells are georeferenced: coordinates + CRS 

--

> Commonly used to represent continuous phenomenon (e.g. temperature, elevation) and images (airborne or satellite imagery)



---
# Raster files 

- Examples of raster file formats: 

  - **GeoTIFF** (see https://trac.osgeo.org/geotiff)
  - **NetCDF** (see https://www.unidata.ucar.edu/software/netcdf/)
  - **KML** (also supports vector objects, see https://www.ogc.org/standards/kml/)
  - **GeoPackage** (also supports vector objects, see https://www.ogc.org/standards/geopackage)
  
--

- `r icon::fontawesome("info-circle")` More details :

  - https://gisgeography.com/gis-formats/
  - https://gdal.org/drivers/raster/index.html


---
# About `r rfa("r-project")`

> R is a programming language and free software environment for statistical computing and graphics supported by the R Foundation for Statistical Computing. &nbsp;&nbsp; [Wikipedia](https://bit.ly/2WFv1Nu)

--

.center[![:scale 50%](https://roelverbelen.netlify.app/img/hex-stickers.png)]



---
# Coding vs clicking

### 1. Programming/coding allows to automate what is frequently done!

--

### 2. Allow to make an analysis/a report reproducible 

--

  - create data pipeline 
  - for colleagues and future you

--

### 3. Increase efficiency (spend more time thinking)


--

### 4. Empowerment 


???

One is not better than the other

---
# Why `r rfa("r-project")`?

<br>

### 1. Freeware + Open source

--

### 2. **Package ecosystem** is rich and under active development  

--

### 3. Community is wide, involved, responsive

--

### 4. You are most likely already using it!

--

### 5. Many packages connect `r rfa("r-project")` to other software/langage

--

### **`r rfa("arrow-right")` Very little cannot be done with `r rfa("r-project")`**


???

Very few people look at the R source code but many people are now involved in package dev via GH or GL.

R Python Julia, whatever, language itself matters less that these
If you have time to learn a bit it might sometime makes sense, notably to work with other colleagues.

















---

class: inverse, center, middle

# `r rfa("pen")` Input/Ouput 

![:custom_hr]()

## Read and write raster files (45min)

???

Will introduce a bit more package to deal with raster in R


---
# `r rfa("r-project")` packages ecosystem for spatial objects

## Classes and Methods 

--

### Vectors 

- [`sp`](https://CRAN.R-project.org/package=sp)
- [`sf`](https://CRAN.R-project.org/package=sf) `r rfa("check")`

--

### **Rasters** (our main focus)

- [`raster`](https://CRAN.R-project.org/package=raster) `r rfa("check")`
- [`stars`](https://CRAN.R-project.org/package=stars) `r rfa("check")`
- [`terra`](https://CRAN.R-project.org/package=terra) 


???

Not visualisation later 



---
# Raster packages

### [`raster`](https://CRAN.R-project.org/package=raster) .font90[03/2010 (1.0.0) &nbsp; // &nbsp; 11/2020 (3.3-7)]
  
<br>

--
  
### [`terra`](https://CRAN.R-project.org/package=terra) .font90[03/2019 (0.5-2) &nbsp; // &nbsp; 11/2020 (0.9-11)]
  
> terra is an R package that replaces raster. It has a very similar interface, but it is simpler and much faster. 

<br>
--
  
### [`stars`](https://CRAN.R-project.org/package=stars) .font90[07/2018  (0.1-1) &nbsp; // &nbsp; 07/2020 (0.4-3)]
  
> Reading, manipulating, writing and plotting spatiotemporal arrays (raster and vector data cubes) in 'R'. 

Depends on [`sf`](https://CRAN.R-project.org/package=sf).
Note that `stars` and `sf` are [Tidyverse](https://www.tidyverse.org/) friendly.



---
# Package [raster](https://CRAN.R-project.org/package=raster)


### - Well documented 
  
  - see https://rspatial.org/raster/
  - many blog posts and tutorials (e.g. https://datacarpentry.org/r-raster-vector-geospatial/01-raster-structure/)

<!-- length(devtools::revdep("raster", dependencies = c("Depends", "
   Imports"))) -->

--

### - 383 packages depend on or import `raster` 

--

### - Depends on `sp` but also works with `sf`.


---
# Package [stars](https://CRAN.R-project.org/package=stars): SpatioTemporal ARrayS

### Extent `sf` to Raster and Vector Datacubes

.center[[![:scale 62%](https://raw.githubusercontent.com/r-spatial/stars/master/images/cube3.png)](https://r-spatial.github.io/stars/index.html)] 
.right[.font80[see https://r-spatial.github.io/stars/index.html]]


---
# Package [stars](https://CRAN.R-project.org/package=stars): SpatioTemporal ARrayS

### - Well documented too

.center[![:scale 92%](img/pkgdown_stars.png)]
.right[.font80[see https://r-spatial.github.io/stars/index.html]]

--

### - 9 packages depend on [`stars`](https://CRAN.R-project.org/package=stars)

### - So far, less material available online.


---
# Read a raster file 


## .center[.font200[ `r rfa("file")` `r rfa("arrow-right")` `r rfa("r-project")`]]

<br>

--

### 1. Files you created 

--

### 2. Files you found on the Internet 

--

### 3. `r rfa("r-project")` packages to download raster files



---
# Example file 

![Accessed 16/12/2020](img/gebco.png)

https://download.gebco.net/ 




---
# Read with *raster*


```{R read_raster}
library(raster)
rar <- raster("data/bathy.tif")  
class(rar)
```


---
# Read with *raster*

```{R plot_raster, eval = FALSE}
plot(rar)
```



---
# Read with *stars*

```{R read_stars}
library(stars)
ras <- read_stars("data/bathy.tif")  
class(ras)
```

---
# Read with *stars*

```{R plot_stars, eval = FALSE}
plot(ras)
```

---

# So ...

<br>

## - GeoTIFF `r icon::fontawesome("check")`

--

## - Other formats, how do I know?



---
# Check read/write capabilities with [raster](https://CRAN.R-project.org/package=raster)

```{R raster_drivers}
ra_dr <- rgdal::gdalDrivers()
head(ra_dr)
ra_dr[which(ra_dr$name == "GTiff"), ]
```

---
# Check read/write capabilities with [stars](https://CRAN.R-project.org/package=stars)


<!-- https://gdal.org/drivers/raster/index.html -->


```{R stars_drivers}
st_dr <- sf::st_drivers(what = "raster")
head(st_dr)
st_dr[which(st_dr$name == "GTiff"), ]
```

<!-- (-73/-41 62/37) see `data` -->


--
.right[.font80[`r icon::fontawesome("info-circle")` More details https://gdal.org/drivers/raster/index.html]]




---
# Write raster files

##  .center[.font200[`r rfa("r-project")` `r rfa("arrow-right")` `r rfa("file")`]]

--

### - Share 

--

### - Use another software

--

<br>

### `r icon::fontawesome("exclamation-circle")` Create an `output` directory

```{R create_dir}
dir.create("output", showWarnings = FALSE)
```


---
# Write with *raster*

```{R write_raster0}
ra_dr$name[ra_dr$create]
```

---
# Write with *raster*

```{R write_raster1, eval = FALSE}
writeRaster(rar, filename = "output/rar.gpkg", format = "GPKG", overwrite = TRUE)
```


---
# Write with *stars*

```{R write_stars0}
sort(st_dr$name[st_dr$write])
```

---
# Write with *stars*

```{R write_stars1, eval = FALSE}
write_stars(ras, dsn = "output/ras.gpkg", driver = "GPKG")
```

`r rfa("pencil-alt")` dsn stand for **data source name**.


---
# Recap 


| Action            | *raster*                 | *stars*               |
|:------------------|:-------------------------|:----------------------|
| list drivers      | `rgdal::gdalDrivers()`   | `sf::st_drivers()`    |
| read files        | `raster()`               | `read_stars()`        |
| write files       | `rasterWrite()`          | `read_stars()`        |



---
# `r rfa("terminal")` R as a raster file converter 

```{r, echo = FALSE}
countdown::countdown(minutes = 10, seconds = 0)
```
<br>

--

### `r rfa("star")` Convert `bathy.tif` into `bathy.grd` 

--

### `r rfa("star")` `r rfa("star")` Create a function `conv_raster()` that handles any conversion supported 

<br>














---

class: inverse, center, middle

# `r rfa("cogs")` Manipulate 

![:custom_hr]()

## Do whatever you need with raster files (~1h30)

---
# Common operation 

- change projection 
- clip/mask 
- extraction
- basic calculations (e.g. average per regions, min/max)
- stack 
- resample 
- rasterization/polygonation 


---
# What do we have? [`raster`](https://CRAN.R-project.org/package=raster)

```{R raster_obj}
class(rar)
rar
```

---
# What do we have ? [`raster`](https://CRAN.R-project.org/package=raster)

```{R raster_obj_fun}
dim(rar)
ncell(rar)
projection(rar)
bbox(rar)
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj}
class(ras)
ras
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun1}
dim(ras)
ncell(ras)
st_bbox(ras)
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun2}
ras_crs <- st_crs(ras)
ras_crs
```

---
# What do we have? [`stars`](https://CRAN.R-project.org/package=stars)

```{R stars_obj_fun3}
ras_crs$proj4string
ras_crs$epsg
```

- https://epsg.io/
- https://epsg.io/4326



---
# Change projection 



---
# Clip 




---
# Mask 



---
# Extraction

<!-- density -->


---
# Recap 


| operation             | `raster`                | `stars`                |
|:----------------------|:------------------------|:-----------------------|
| reprojection          | projectRaster()         | st_transform()         |







---

class: inverse, center, middle

# `r rfa("map")` Visualize

![:custom_hr]()

## Static visualization (~1h)



---
# `r rfa("r-project")` packages ecosystem for spatial objects

## Visualization

--

### Static

- [`tmap`](https://CRAN.R-project.org/package=tmap)
- [`ggmap`](https://CRAN.R-project.org/package=ggmap)

--

### Interactive 

- [`rasterVis`](https://CRAN.R-project.org/package=rasterVis)
- [`leaflet`](https://CRAN.R-project.org/package=leaflet)
- [`mapview`](https://CRAN.R-project.org/package=mapview)





---
# Exercice + countdown

1. Do that 
2. Do that 
3. Do that 
4. Do that 
5. Do that 

```{r, echo = FALSE}
countdown::countdown(minutes = 5, seconds = 0)
```


---

# Resources `r rfa("link")`

- [Geocomputation with R](https://geocompr.robinlovelace.net/)
- [Blog R-spatial](https://www.r-spatial.org/)
- [Open Geospatial Consortium](https://www.ogc.org/)
- https://nowosad.github.io/BioGIS_19/workshop/#64